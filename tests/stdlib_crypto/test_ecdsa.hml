// Test: @stdlib/crypto - ECDSA signatures

import { ecdsa_generate_key, ecdsa_sign, ecdsa_verify, ecdsa_free_keys } from "@stdlib/crypto";

print("Testing ECDSA signatures...");

// Test 1: Generate ECDSA key pair
print("Generating ECDSA P-256 key pair...");
let keypair = ecdsa_generate_key();
defer ecdsa_free_keys(keypair);

if (typeof(keypair) != "ECDSAKeyPair") {
    throw "Expected ECDSAKeyPair type, got " + typeof(keypair);
}
print("âœ“ ECDSA key generation");

// Test 2: Sign a message
let message = "This is a test message";
let signature = ecdsa_sign(message, keypair);

if (typeof(signature) != "buffer") {
    throw "Expected buffer signature, got " + typeof(signature);
}

// ECDSA P-256 signature should be ~70-72 bytes (DER-encoded)
if (signature.length < 60 || signature.length > 80) {
    throw "Unexpected signature length: " + typeof(signature.length);
}
print("âœ“ ECDSA signing (signature: " + typeof(signature.length) + " bytes)");

// Test 3: Verify signature
let valid = ecdsa_verify(message, signature, keypair);

if (valid != true) {
    throw "Signature verification failed";
}
print("âœ“ ECDSA signature verification");

// Test 4: Tampered message fails verification
let tampered = "This is a test messag3";  // Changed last character
let tampered_valid = ecdsa_verify(tampered, signature, keypair);

if (tampered_valid != false) {
    throw "Tampered message should fail verification";
}
print("âœ“ Tampered message fails verification");

// Test 5: Tampered signature fails verification
// Flip a bit in the signature
signature[0] = signature[0] ^ 1;
let tampered_sig_valid = ecdsa_verify(message, signature, keypair);

if (tampered_sig_valid != false) {
    throw "Tampered signature should fail verification";
}
print("âœ“ Tampered signature fails verification");

// Test 6: Sign again (regenerate signature)
let signature2 = ecdsa_sign(message, keypair);
let valid2 = ecdsa_verify(message, signature2, keypair);

if (valid2 != true) {
    throw "Second signature verification failed";
}
print("âœ“ Multiple signatures work");

// Test 7: Different messages produce different signatures
let message2 = "This is a different message";
let signature3 = ecdsa_sign(message2, keypair);

let same = true;
let i = 0;
let min_len = signature2.length;
if (signature3.length < min_len) {
    min_len = signature3.length;
}

while (i < min_len) {
    if (signature2[i] != signature3[i]) {
        same = false;
    }
    i = i + 1;
}

if (same) {
    throw "Different messages should produce different signatures";
}
print("âœ“ Different messages produce different signatures");

// Test 8: Long message
let long_message = "This is a very long message that will test ECDSA signing with larger inputs. ";
i = 0;
while (i < 10) {
    long_message = long_message + long_message;
    i = i + 1;
}

let long_sig = ecdsa_sign(long_message, keypair);
let long_valid = ecdsa_verify(long_message, long_sig, keypair);

if (long_valid != true) {
    throw "Long message signature verification failed";
}
print("âœ“ Long message signing/verification");

// Test 9: Empty string
let empty = "";
let empty_sig = ecdsa_sign(empty, keypair);
let empty_valid = ecdsa_verify(empty, empty_sig, keypair);

if (empty_valid != true) {
    throw "Empty string signature verification failed";
}
print("âœ“ Empty string signing/verification");

// Test 10: Unicode/UTF-8
let unicode = "Hello ðŸŒ! ECDSA signatures with Hemlock ðŸš€";
let unicode_sig = ecdsa_sign(unicode, keypair);
let unicode_valid = ecdsa_verify(unicode, unicode_sig, keypair);

if (unicode_valid != true) {
    throw "Unicode signature verification failed";
}
print("âœ“ Unicode signing/verification");

// Test 11: ECDSA signatures are non-deterministic (randomized k)
// Different calls should produce different signatures for same message
let sig_a = ecdsa_sign(message, keypair);
let sig_b = ecdsa_sign(message, keypair);

same = true;
i = 0;
min_len = sig_a.length;
if (sig_b.length < min_len) {
    min_len = sig_b.length;
}

while (i < min_len) {
    if (sig_a[i] != sig_b[i]) {
        same = false;
    }
    i = i + 1;
}

if (same) {
    print("âš  Warning: ECDSA signatures are identical (expected different due to random k)");
} else {
    print("âœ“ ECDSA signatures are randomized");
}

// Both should verify
if (!ecdsa_verify(message, sig_a, keypair) || !ecdsa_verify(message, sig_b, keypair)) {
    throw "Both ECDSA signatures should verify";
}

print("All ECDSA tests passed!");
