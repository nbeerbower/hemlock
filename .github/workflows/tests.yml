name: Tests

on:
  push:
    branches: [ main, master, 'claude/**' ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Main test job - interpreter tests
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc make libwebsockets-dev libffi-dev zlib1g-dev

    - name: Build
      run: make clean && make && make stdlib

    - name: Run tests
      run: make test

  # Compiler tests
  compiler:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc make libwebsockets-dev libffi-dev zlib1g-dev

    - name: Build compiler
      run: make compiler

    - name: Run compiler tests
      run: make test-compiler

  # Parity tests - verify compiled code matches interpreter
  parity:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc make libwebsockets-dev libffi-dev zlib1g-dev

    - name: Build interpreter and compiler
      run: |
        make clean && make
        make compiler
        make stdlib || true

    - name: Run parity tests
      run: make parity

  # Bundler tests
  bundler:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc make libwebsockets-dev libffi-dev zlib1g-dev

    - name: Build interpreter
      run: make clean && make && make stdlib || true

    - name: Run bundler tests
      run: make test-bundler

  # Memory checks with AddressSanitizer
  asan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc make libwebsockets-dev libffi-dev zlib1g-dev

    - name: Build with ASAN
      run: |
        make clean
        CFLAGS="-fsanitize=address -fno-omit-frame-pointer -g" \
        LDFLAGS="-fsanitize=address" \
        make

    - name: Build stdlib
      run: make stdlib || true

    - name: Run tests with ASAN
      run: make test
      env:
        ASAN_OPTIONS: detect_leaks=1:halt_on_error=0

  # Valgrind memory check (optional, informational)
  valgrind:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc make libwebsockets-dev libffi-dev zlib1g-dev valgrind

    - name: Build
      run: make clean && make && make stdlib || true

    - name: Run valgrind
      run: make valgrind
      continue-on-error: true

    - name: Upload valgrind logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: valgrind-logs
        path: valgrind-*.log
        if-no-files-found: ignore
